{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}
{% load static %}
{% load slippers %}

{% block subbody %}
<div class="row">
    <div class="col-lg-4 col-md-4 col-sm-12" align="right">
      <img src="../media/masters/{{ request.user.pk|default_if_none:'images/none' }}.jpg"
           class="rounded-circle border border-5 border-white" align="center" width="100">
    </div>
    <div class="col-lg-8 col-md-8 col-sm-12" align="left" >
     <a href="" ><b>{{ request.user }} </b></a>
    </div>

</div>
{% endblock subbody%}

{% block body %}

<style>
  .tab {
    display: flex;
    flex-wrap: wrap;
  }

  .tab > input[type="radio"] {
    display: none;
  }

  .tab-content {
    display: none;
    width: 100%;
    margin-top: 1rem;
  }

{% regroup orders by order_status as order_list %}

#tab-btn-0:checked~#content-0,
#tab-btn-1:checked~#content-1,

{% for z in order_list %}
#tab-btn-{{z.grouper}}:checked~#content-{{z.grouper}},
{% endfor %}


#tab-btn-0:checked~#content-0
  {
    display: block;
  }

  .tab > label {
    display: block;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out;
    text-decoration: none;
    color: #ca5718;
    border: 0;
    border-radius: 0.375rem;
    background: 0 0;
  }

  .tab > input[type="radio"]:checked + label {
    cursor: default;
    color: #fff;
    background-color: #ca5718;
  }
</style>

<div class="container">

    <div class="tab">
        <!--menu apartments-->
        <input id="tab-btn-0" checked name="tab-btn" type="radio" value="">
        <label for="tab-btn-0">Create new request</label>
        <input id="tab-btn-1" name="tab-btn" type="radio" value="">
        <label for="tab-btn-1">Add new request</label>

        {% for i in order_list %}
        <input id="tab-btn-{{ i.grouper }}" name="tab-btn" type="radio" value="">
        <label for="tab-btn-{{ i.grouper }}">{{ i.grouper|choice_tag:'status_order' }} - {{i.1|length}}</label>
         {% endfor %}

        <!--end menu apartments-->


        <div class="tab-content" id="content-0">
            {% #form form_order_=form_order form_appart_=form_appart form_customer_=form_customer %}
                {% csrf_token %}
            {% /form %}
        </div>

        <div class="tab-content" id="content-1">
                <input type="text" id="hh" name="client" value="" placeholder="Enter customer details" >
                <div id="aaa"></div>
        </div>

        {% for i in order_list %}
        <div class="tab-content" id="content-{{ i.grouper }}">
            {% for b in i.list %}
            <div class="row border-bottom mb-3 p-1">
                <div class="col-4 " >
                    <a href="../list_order/{{b.pk}}" id="order_{{ b.pk }}" class ='text-secondary'>
                    Order № {{ b.pk }}</a>, {{ b.time_in|date:"d b Y" }}
                    <a href="{% url 'delete-order' b.pk %}" id="delete_{{ b.pk }}" class="mycolor mr-1 text-secondary" title="Delete order">
                        <i class="fas fa-trash text-secondary ml-5"></i>
                    </a><br>

                    <a href="{{ b.customer_id.pk }}" id="link_customer" class="text-secondary" data-toggle="modal" data-target="#exampleModal" title="client">
                        
                        {{ b.customer_id.customer_name }}
                    </a>

                    <div class="mt-2 ">
                        <span id="city_{{ b.pk }}" >{{ b.apartment_id.address_city|choice_tag:'city'}}</span>,
                        <span id="street_app_{{ i.pk }}">{{ b.apartment_id.address_street_app|capfirst }}</span>,
                        <span id="num_{{ i.pk }}">{{ b.apartment_id.address_num }}</span>.
                    </div>
                </div>

                <div class="col-4 ">
                    <span class="text-secondary"> {{ b.text_order }}</span>
                </div>

                <div class="col-4">
                      <img src="../media/masters/{{ b.repairer_id.pk }}.jpg"
                           class="rounded-circle" align="center" width="60"><br>
                     <a href="" class="text-secondary">
                         <b>{{ b.repairer_id.username }}</b>
                     </a>
                </div>
            </div>
            {% endfor %}
        </div>

        {% endfor %}
    </div>
</div>

{% #owner_modal_window   %}
{% csrf_token %}
{% /owner_modal_window %}

<script>
<!--  SHOW CLIENT INFO WINDOW WHEN YOU PUT A CLIENT NAME  -->
$(document).on('click', '#link_customer', function (e) {
    e.preventDefault();

         $.ajax({
            url: "../client?pk="+$(this).attr("href") ,
            type: "GET",
            dataType: 'json',

            success: function(response){
            document.getElementById("name").innerHTML =response.name;
            document.getElementById("customer_phone").innerHTML =' '+response.phone;
            document.getElementById("customer_telegram").innerHTML = ' '+response.telegram;
            document.getElementById("profile").innerHTML = response.profile;
            document.getElementById("foto1").src ='../media/'+response.foto;
            document.getElementById("customer_id").value =response.pk;

            b=JSON.parse(response.orders);
            c=JSON.parse(response.apartment);

            let f=$('div[new="new"]');
                    for (i = 0; i < f.length; i++) {
                        f[i].remove();
                    }

            let a=$('div[ap="ap"]');
                    for (i = 0; i < a.length; i++) {
                        a[i].remove();
                    }

            b.forEach((element, index ) =>  {
            let order_ = $("#order1").clone();
                order_.attr('id', 'order_'+element.pk);
                order_.attr('new', 'new');
                order_.attr('class', 'prefix text-secondary mb-2');
                let date_order=element.time_in.substr(0, 10).split("-").reverse().join(".");
                order_.html('<div class="mb-2 mb-3 border-bottom"><a href=../list_order/' + element.pk + ' class="prefix text-secondary ">' + date_order + ' | ' + element.text_order + '</a></div>');
                $('#order1').after(order_);
            })

            c.forEach((element, index ) =>  {
            let ap_ = $("#apart").clone();
                ap_.attr('id', 'ap_');
                ap_.attr('ap', 'ap');
                ap_.attr('class', 'prefix text-secondary mb-2');
                ap_.html('<div class="row mb-3 border-bottom"><div class="col-7">'+element.address_street_app + ' '+element.address_num +', '+ element.address_city + '<input type="hidden" name="form-'+index+'-apartment_id" id="id_form-'+index+'-apartment_id" value='+ element.pk +'> <br><input hidden type="text" id="id_form-'+index+'-text_order" name="form-'+index+'-text_order" placeholder="Input your job"> </div> <div class="col-5"><a class="mycolor " href="#" onclick=show_input_form(document.getElementById("id_form-'+index+'-text_order"))>add new request</a></div></div>');
                $('#apart').after(ap_);
            })
         }
    });
})

<!-- SENT AJAX - CREATE NEW REQUEST FROM CLIENT WINDOW -->
$(document.body).ready(function() {
    $('#form_customer').submit(function(e) {
        e.preventDefault();
            $.ajax({
                url: '../save_list',
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'text',
                beforeSend: function () {$("#form").html('<h3>Sending...</h3>');},
                success: function (resp) {window.location.href = '/list_order?work_status=SND'},
            });
    });
});



<!--CREATE NEW REQUEST -->

$(document.body).ready(function() {

    $('#form').submit(function(e) {
        e.preventDefault();
            $.ajax({
                url: '../',
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'text',
                beforeSend: function () {$("#form").html('<h3>Отправляется...</h3>');},
                success: function (resp) {

                    if (JSON.parse(resp).auth==true) {
                        window.location.href = '/list_order/'+JSON.parse(resp).pk;
                    }
                    else {
                        $("#form").html(JSON.parse(resp).message);
                    }
                },
            });

    });
});


 $(document.body).on( "input", "#hh", function(e) {
        e.preventDefault();

         $.ajax({
            url: "../api/getclient?client="+$(this).val() ,
            type: "GET",

            dataType: 'json',
            success: function(response){
                $('#aaa').html(" ")
                 for (i = 0; i < response.length; i++) {

                            $('#aaa').append('<div class="row border-bottom mb-2"><div class="col-4"><a href="'+response[i].pk+'" id="link_customer" class="text-secondary" data-toggle="modal" data-target="#exampleModal">'+response[i].customer_name+'</div><div class="col-4">  '+response[i].phone+'</div><div class="col-4"> '+response[i].telegram+'</a></div></div>');



                        }
                 $('#aaa').append('<a href="/clients" class="text-secondary">See more...</a>');
            }
        });
    });

function show_input_form(input) {
    if (input.hidden == false)  {input.hidden = true;}

    else {input.hidden = false;}
}
</script>
{% endblock body %}
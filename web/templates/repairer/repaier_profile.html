{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}
{% load static %}
{% load slippers %}

                            {% block subbody %}

                            {% endblock subbody%}

{% block body %}

<div class="container">
    <div class="row">
        <div class="col-lg-6 col-md-10 col-sm-12 pt-3 text-center border-right">
            <h4>
              {{ user.last_name }} {{ user.first_name }} | <strong class="mycolor"> {{ request.user.username }}</strong>
            </h4>
            City: {{ profile.city|choice_tag:'city' }}
            <a href="{% url 'update-user' profile.pk %}" class="mycolor" title="изменить данные"><i class="fas fa-pen text-secondary mt-3"> </i></a>
            <br>
            <img src="../media/{{ profile.foto|default_if_none:'images/none.jpg' }} " alt="Муж на час" class="rounded-circle" align="center" width="200">
            <br>
            Completed jobs: {{ count }}<br>
            Income: {{ sum }}<br>
            Skills: {{ profile.rating_sum}}({{ profile.rating_num}})
        </div>

        <div class="col-lg-6 col-md-10 col-sm-12 pt-3">
        {% regroup orders by order_status as order_list %}
            {% for i in order_list %}
            <h5 class="mycolor border-bottom">
                {{ i.grouper|choice_tag:'status_order' }}
            {% if i.0 == 'SND' %}
            <a id="toggleLinkqq" class="btn btn-sm btn-orange" href="javascript:void(0)" onclick="viewdiv('qq')"
             data-text-hide="create new request" data-text-show="close" >create new request</a>
            <a id="toggleLinkqqq" href="#" class="btn btn-sm btn-orange" href="javascript:void(0)" onclick="viewdiv('qqq')"
             data-text-hide="add new request" data-text-show="close" >add new request</a>
            {% endif %}
            </h5>
            <div id="qq" style="display:none;" class="mb-5">
                {% #form form_order_=form_order form_appart_=form_appart form_customer_=form_customer %}
                {% csrf_token %}
                {% /form %}
            </div>

            <div id="qqq" style="display:none;" class="mb-5">
                <input type="text" id="hh" name="client" value="" placeholder="Enter customer details" >
                <div id="aaa"></div>
            </div>

                {% for b in i.list %}
                <div class="mb-3 p-1 border-bottom rounded">
                    <a id="toggleLinkmydiv{{ b.pk }}" href="javascript:void(0)" onclick="viewdiv('mydiv{{ b.pk }}')"
                       data-text-hide="+" data-text-show="-" class="text-secondary">+</a> |
                    <a href="../list_order/{{b.pk}}" id="order_{{ b.pk }}" class ='text-secondary'>
                    Order № {{ b.pk }}</a> | {{ b.time_in }} |
                    <a href="{{ b.customer_id.pk }}" id="link_customer" class="text-secondary" data-toggle="modal" data-target="#exampleModal">  {{ b.customer_id.customer_name }}</a>

                     <a href="{% url 'clients_update' b.customer_id.pk %}" class="text-secondary ml-3" title="upgrade data" >
                            <i class="fas fa-pen text-secondary" style='font-size:14px'> </i>
                        </a>

                    <div id="mydiv{{ b.pk }}" style="display:none;">
                        {% if b.customer_id.phone %}
                        <a href="tel:+{{ b.customer_id.phone }}" title="Phone" id="customer_phone_{{ b.pk }}"
                           class="fas fa-phone btn prefix text-secondary mt-2" aria-hidden="true">
                        </a>
                        {% endif %}
                        {% if b.customer_id.telegram %}
                        <a href="https://t.me/{{ b.customer_id.telegram|cut:'@' }}" title="Telegram" id="customer_id.telegram_{{ b.pk }}"
                            class ="fas fa fa-paper-plane btn text-secondary mt-2" aria-hidden="true">
                        </a>
                        {% endif %}
                        {% if b.customer_id.whatsapp %}
                        <a href="https://wa.me/+{{ b.customer_id.whatsapp }}" id="watsapp_{{ i.pk }}" class="fa fab fa-whatsapp-square btn prefix text-secondary mt-2"
                            title="Whatsapp" aria-hidden="true" >
                        </a>
                        {% endif %}
                        {% if b.apartment_id.link_location %}
                        <a href="{{b.apartment_id.link_location}}"  class="fas fa-map-marker btn prefix text-secondary mt-2" title="Open map" aria-hidden="true" >
                        </a>
                        {% endif %}
                    </div>

                    <div class="mt-2">
                        {{ b.text_order }}
                    </div>
                </div>

                {% endfor %}

               {% empty %}
                <div class="mb-3 p-2 border border-5 rounded"><h3>No orders in progress</h3>
            <a href="{% url 'list_order' %}" class="mycolor">All orders</a></div>
            {% endfor %}
        </div>
    </div>
</div>


<!-- Modal Window -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body  mx-3">
                <div id="contact" class="form-container">
                    <fieldset>
                        <div id="message">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                        </div>
                    </fieldset>
                        <div class="row">
                            <div class="col-12 text-center">
                                <h4 id="name" class="mycolor font-weight-bold"></h4>
                                <img id="foto1" class="rounded-circle" align="" width="100">
                                <div class="row center" hidden id="profile"></div>
                            </div>
                        </div>
                        <div class="row mb-3 border-bottom">

                            <div class="col-6 text-center"><a href="tel:" title="Phone"  id="customer_phone" class="fas fa-phone prefix text-secondary mt-3" aria-hidden="true"></a></div>
                            <div class="col-6 text-center"><a href="https://t.me/" title="Telegram" id="customer_telegram" class ="fas fa fa-paper-plane text-secondary mt-3" aria-hidden="true"></a></div>
                        </div>


                        <form method="post" action="" name="form" id="form_customer">{% csrf_token %}

                        <div>
                            <input type="hidden" name="form-TOTAL_FORMS" id="id_form-TOTAL_FORMS" value="20">
                            <input type="hidden" name="form-INITIAL_FORMS" id="id_form-INITIAL_FORMS" value="0">
                            <input type="hidden" name="form-MIN_NUM_FORMS" id="id_form-MIN_NUM_FORMS">
                            <input type="hidden" name="form-MAX_NUM_FORMS" id="id_form-MAX_NUM_FORMS"></div>
                            <input type="hidden" name="customer_id" id="customer_id" value="">

                        <div class="row mb-2 mt-2" id="apart">
                            Apartments:
                        </div>
                        <button type="submit" name="submit" class="btn btn-sm btn-orange cta-btn btn-form mt-3 mb-5 ">
                            Send
                        </button>

                        </form>
                        <div class="row mb-2 mt-2" id="order1">5 latest client requests::
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- And Modal Window -->


<script>
<!--  SHOW CLIENT INFO WINDOW WHEN YOU PUT A CLIENT NAME  -->
$(document).on('click', '#link_customer', function (e) {
    e.preventDefault();

         $.ajax({
            url: "../client?pk="+$(this).attr("href") ,
            type: "GET",
            dataType: 'json',

            success: function(response){
            document.getElementById("name").innerHTML =response.name;
            document.getElementById("customer_phone").innerHTML =' '+response.phone;
            document.getElementById("customer_telegram").innerHTML = ' '+response.telegram;
            document.getElementById("profile").innerHTML = response.profile;
            document.getElementById("foto1").src ='../media/'+response.foto;
            document.getElementById("customer_id").value =response.pk;

            b=JSON.parse(response.orders);
            c=JSON.parse(response.apartment);

            let f=$('div[new="new"]');
                    for (i = 0; i < f.length; i++) {
                        f[i].remove();
                    }

            let a=$('div[ap="ap"]');
                    for (i = 0; i < a.length; i++) {
                        a[i].remove();
                    }

            b.forEach((element, index ) =>  {
            let order_ = $("#order1").clone();
                order_.attr('id', 'order_'+element.pk);
                order_.attr('new', 'new');
                order_.attr('class', 'prefix text-secondary mb-2');
                let date_order=element.time_in.substr(0, 10).split("-").reverse().join(".");
                order_.html('<div class="mb-2 mb-3 border-bottom"><a href=../list_order/' + element.pk + ' class="prefix text-secondary ">' + date_order + ' | ' + element.text_order + '</a></div>');
                $('#order1').after(order_);
            })

            c.forEach((element, index ) =>  {
            let ap_ = $("#apart").clone();
                ap_.attr('id', 'ap_');
                ap_.attr('ap', 'ap');
                ap_.attr('class', 'prefix text-secondary mb-2');
                ap_.html('<div class="row mb-3 border-bottom"><div class="col-7">'+element.address_street_app + ' '+element.address_num +', '+ element.address_city + '<input type="hidden" name="form-'+index+'-apartment_id" id="id_form-'+index+'-apartment_id" value='+ element.pk +'> <br><input hidden type="text" id="id_form-'+index+'-text_order" name="form-'+index+'-text_order" placeholder="Input your job"> </div> <div class="col-5"><a class="mycolor " href="#" onclick=show_input_form(document.getElementById("id_form-'+index+'-text_order"))>add new request</a></div></div>');
                $('#apart').after(ap_);
            })
         }
    });
})

<!-- SENT AJAX - CREATE NEW REQUEST FROM CLIENT WINDOW -->
$(document.body).ready(function() {
    $('#form_customer').submit(function(e) {
        e.preventDefault();
            $.ajax({
                url: '../save_list',
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'text',
                beforeSend: function () {$("#form").html('<h3>Sending...</h3>');},
                success: function (resp) {window.location.href = '/list_order?work_status=SND'},
            });
    });
});

<!--SHOW INPUT IN CLIENT WINDOW-->
function show_input_form(input) {
    if (input.hidden == false)  {input.hidden = true;}
    else {input.hidden = false;}
}

<!--SHOW ELEMENTS -->
function viewdiv(id) {
    var el = document.getElementById(id);
    var link = document.getElementById('toggleLink'+id);
    if (el.style.display == "block") {
        el.style.display = "none";
        link.innerText = link.getAttribute('data-text-hide');
    } else {
        el.style.display = "block";
        link.innerText = link.getAttribute('data-text-show');
    }
}


<!--CREATE NEW REQUEST -->

$(document.body).ready(function() {

    $('#form').submit(function(e) {
        e.preventDefault();
            $.ajax({
                url: '../',
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'text',
                beforeSend: function () {$("#form").html('<h3>Отправляется...</h3>');},
                success: function (resp) {

                    if (JSON.parse(resp).auth==true) {
                        window.location.href = '/list_order/'+JSON.parse(resp).pk;
                    }
                    else {
                        $("#form").html(JSON.parse(resp).message);
                    }
                },
            });

    });
});



 $(document.body).on( "input", "#hh", function(e) {
        e.preventDefault();

         $.ajax({
            url: "../api/getclient?client="+$(this).val() ,
            type: "GET",

            dataType: 'json',
            success: function(response){
                $('#aaa').html(" ")
                 for (i = 0; i < response.length; i++) {

                            $('#aaa').append('<div class="row border-bottom mb-2"><div class="col-4"><a href="'+response[i].pk+'" id="link_customer" class="text-secondary" data-toggle="modal" data-target="#exampleModal">'+response[i].customer_name+'</div><div class="col-4">  '+response[i].phone+'</div><div class="col-4"> '+response[i].telegram+'</a></div></div>');



                        }
                 $('#aaa').append('<a href="/clients" class="text-secondary">See more...</a>');
            }
        });
    });

</script>
{% endblock body %}
{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}
{% load static %}
{% load slippers %}

{% block subbody %}
<div class="row">
    <div class="col-lg-4 col-md-4 col-sm-12" align="right">
      <img src="../media/masters/{{ request.user.pk|default_if_none:'images/none' }}.jpg"
           class="rounded-circle border border-5 border-white" align="center" width="100">
    </div>
    <div class="col-lg-8 col-md-8 col-sm-12" align="left" >
     <a href="" ><b>{{ request.user }} </b></a>
    </div>

</div>
{% endblock subbody%}

{% block body %}

<style>
  .tab {
    display: flex;
    flex-wrap: wrap;
  }

  .tab > input[type="radio"] {
    display: none;
  }

  .tab-content {
    display: none;
    width: 100%;
    margin-top: 1rem;
  }

{% regroup orders by order_status as order_list %}

#tab-btn-0:checked~#content-0,
#tab-btn-1:checked~#content-1,

{% for z in order_list %}
#tab-btn-{{z.grouper}}:checked~#content-{{z.grouper}},
{% endfor %}


#tab-btn-0:checked~#content-0
  {
    display: block;
  }

  .tab > label {
    display: block;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out;
    text-decoration: none;
    color: #ca5718;
    border: 0;
    border-radius: 0.375rem;
    background: 0 0;
  }

  .tab > input[type="radio"]:checked + label {
    cursor: default;
    color: #fff;
    background-color: #ca5718;
  }
</style>

<div class="container">

    <div class="tab">
        <!--menu apartments-->
        <input id="tab-btn-0" checked name="tab-btn" type="radio" value="">
        <label for="tab-btn-0">Create new request</label>
        <input id="tab-btn-1" name="tab-btn" type="radio" value="">
        <label for="tab-btn-1">Add new request</label>

        {% for i in order_list %}
        <input id="tab-btn-{{ i.grouper }}" name="tab-btn" type="radio" value="">
        <label for="tab-btn-{{ i.grouper }}">{{ i.grouper|choice_tag:'status_order' }} - {{i.1|length}}</label>
         {% endfor %}

        <!--end menu apartments-->


        <div class="tab-content" id="content-0">
            {% #form form_order_=form_order form_appart_=form_appart form_customer_=form_customer %}
                {% csrf_token %}
            {% /form %}
        </div>

        <div class="tab-content" id="content-1">
                <input type="text" id="hh" name="client" value="" placeholder="Enter customer details" >
                <div id="aaa"></div>
        </div>

        {% for i in order_list %}
        <div class="tab-content" id="content-{{ i.grouper }}">
            {% for b in i.list %}
            <div class="row border-bottom mb-3 p-1">
                <div class="col-md-4" >
                    <a href="../list_order/{{b.pk}}" id="order_{{ b.pk }}" class ='text-secondary'>
                    Order № {{ b.pk }}</a>, {{ b.time_in|date:"d b Y" }}
                    <a href="{% url 'delete-order' b.pk %}" id="delete_{{ b.pk }}" class="mycolor mr-1 text-secondary" title="Delete order">
                        <i class="fas fa-trash text-secondary ml-5"></i>
                    </a><br>

                    <b class="text-secondary">
                        
                        {{ b.customer_id.customer_name }}
                    </b>

                    <div class="mt-2 ">
                        <span id="city_{{ b.pk }}" >{{ b.apartment_id.address_city|choice_tag:'city'}}</span>,
                        <span id="street_app_{{ i.pk }}">{{ b.apartment_id.address_street_app|capfirst }}</span>,
                        <span id="num_{{ i.pk }}">{{ b.apartment_id.address_num }}</span>.
                    </div>
                </div>

                <div class="col-md-4 ">
                    <span class="text-secondary"> {{ b.text_order }}</span>
                </div>

                <div class="col-md-4">
                      <img src="../media/masters/{{ b.repairer_id.pk }}.jpg"
                           class="rounded-circle" align="center" width="60"><br>


                     {% if b.repairer_id %}
                         <b class="text-secondary">{{ b.repairer_id.username }}</b>
                     {% else %}
                        <a href="" class="link_master" data-toggle="modal" data-target="#exampleModal" title="{{ b.pk }}">Appoint a master to the order</a>
                     {% endif %}

                     </a>
                </div>
            </div>
            {% endfor %}
        </div>

        {% endfor %}
    </div>
</div>

 <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body  mx-3">
                <div id="contact" class="form-container">
                    <fieldset>
                        <div id="message">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">X</span>
                        </button>
                        </div>
                    </fieldset>
                        <div class="row">
                            <div class="col-12 text-center">
                                <h4 id="" class="mycolor font-weight-bold">List of masters</h4>
                            </div>
                        </div>

                        <div class="row" id="master">
                            <div id="pk"></div>
                            {% for i in list_masters %}
                            <div class="col-12 text-center m-2 font-weight-bold" id="master_col">
                                <a href="{{i.pk}}" class="link-text-secondary" title="{{i.pk}}">

                                <img src="../media/masters/{{ i.pk }}.jpg" class="rounded-circle border
                                border-white" align="center" width="70">- {{ i.username }}
                                </a>
                            </div>
                            {% endfor %}
                        </div>


                </div>
            </div>
        </div>
    </div>
</div>



<script>
$(document.body).on( "click", ".link_master", function(e) {
        let b=$(this).attr('title');
        links=document.getElementById('master').querySelectorAll('a');
        links.forEach((element) => element.setAttribute('href', '/setmaster/'+b));

});


<!-- SENT AJAX - SET MASTER FOR ORDER -->
$(document.getElementById('master')).on( "click", ".link-text-secondary", function(e) {
       e.preventDefault();
            $.ajax({
                url: $(this).attr("href"),
                type: 'PATCH',
                data:{repairer_id:$(this).attr("title")},
                dataType: 'json',
                beforeSend: function () {},
                success: function (resp) {},
            });

});
















<!-- SENT AJAX - CREATE NEW REQUEST FROM CLIENT WINDOW -->
$(document.body).ready(function() {
    $('#form_customer').submit(function(e) {
        e.preventDefault();
            $.ajax({
                url: '../save_list',
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'text',
                beforeSend: function () {$("#form").html('<h3>Sending...</h3>');},
                success: function (resp) {window.location.href = '/list_order?work_status=SND'},
            });
    });
});



<!--CREATE NEW REQUEST -->

$(document.body).ready(function() {

    $('#form').submit(function(e) {
        e.preventDefault();
            $.ajax({
                url: '../',
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'text',
                beforeSend: function () {$("#form").html('<h3>Отправляется...</h3>');},
                success: function (resp) {

                    if (JSON.parse(resp).auth==true) {
                        window.location.href = '/list_order/'+JSON.parse(resp).pk;
                    }
                    else {
                        $("#form").html(JSON.parse(resp).message);
                    }
                },
            });

    });
});


 $(document.body).on( "input", "#hh", function(e) {
        e.preventDefault();

         $.ajax({
            url: "../api/getclient?client="+$(this).val() ,
            type: "GET",

            dataType: 'json',
            success: function(response){
                $('#aaa').html(" ")
                 for (i = 0; i < response.length; i++) {

                            $('#aaa').append('<div class="row border-bottom mb-2"><div class="col-4"><a href="'+response[i].pk+'" id="link_customer" class="text-secondary" data-toggle="modal" data-target="#exampleModal">'+response[i].customer_name+'</div><div class="col-4">  '+response[i].phone+'</div><div class="col-4"> '+response[i].telegram+'</a></div></div>');



                        }
                 $('#aaa').append('<a href="/clients" class="text-secondary">See more...</a>');
            }
        });
    });

function show_input_form(input) {
    if (input.hidden == false)  {input.hidden = true;}

    else {input.hidden = false;}
}
</script>
{% endblock body %}
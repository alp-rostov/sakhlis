{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}

{% block body %}
<style>
    .hidden{
    display:none
    }
</style>
<hr>
<button> <a href="/app/logout/">Выйти</a> </button>
<hr>


    <h1>Заявка № {{ info.id }} от : {{ info.time_in }}</h1>

    <table width="700"><tr>
        <td><h2>Заказчик: {{ info.customer_name }}</h2></td>
    </tr>
        <tr>
        <td><b>Адрес: </b>{{ info.address_city }}, {{ info.address_street_app }}, {{ info.address_num }}</td>
    </tr>
    <tr>
         <td><b>Телефон:</b> {{ info.customer_phone }}</td>
    </tr>
    <tr>
         <td><b>Описание проблемы:</b> {{ info.text_order }}</td>
    </tr>
    </table>


<h3>Выполненные работы: </h3>
<form action="" method="post" >
{% csrf_token %}
{{ form.management_form }}
    <div id="ingredient-form-list">
        <script>var i =0; var summ=0</script>
        {% for g in form %}
        <div class="ingredient-form">
            {{ g.as_table }}
            <span class="wer">
                <script>
                    price=document.getElementById('id_form-'+i+'-price').value;
                    quantity=document.getElementById('id_form-'+i+'-quantity').value;
                    i++;
                    document.write('Сумма: '+price*quantity);
                    summ+=price*quantity
                </script>
            </span>
            <a href="delete/{{ g.id.value }}/{{ info.id }}">удалить</a>
            <br>
        </div>
    {% endfor %}
    </div>
    <div id="empty-form" class="hidden">{{ form.empty_form }}</div>
    <button id="add-more" type="button">add-more</button>
    <button type="submit"> "Save" </button>
</form>

<script>
    document.write('ИТОГО: '+ summ)
</script>

<script>
    const addMoreBtn=document.getElementById('add-more')
    const totalNewForms = document.getElementById('id_form-TOTAL_FORMS')
    addMoreBtn.addEventListener('click', add_new_form)

    function add_new_form(event){
        if (event) {
        event.preventDefault()
        }
        const currentIngredientForms = document.getElementsByClassName('ingredient-form')
        const currentFormCount = currentIngredientForms.length // + 1
        const formCopyTarget = document.getElementById('ingredient-form-list')
        const copyEmptyFromEl=document.getElementById('empty-form').cloneNode(true)
        copyEmptyFromEl.setAttribute('class', 'ingredient-form')
        copyEmptyFromEl.setAttribute('id',`form-${currentFormCount}`)
        const regex = new RegExp('__prefix__', 'g')
        copyEmptyFromEl.innerHTML=copyEmptyFromEl.innerHTML.replace(regex,
         currentFormCount)
        totalNewForms.setAttribute('value', currentFormCount+1)
        formCopyTarget.append(copyEmptyFromEl)
    }
</script>


<h3>Статус заказа: {{ info.order_status  | choice_tag:'status_order'}}</h3>


{% if info.order_status == 'END' %}
    <a href="pdf/{{ info.id }}">Квитанция на оплату - PDF</a>
{% else %}
    <a href="">Заказ выполненен - указать статус заказа</a>

{% endif %}

{% endblock body %}
{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}

{% block body %}
<style>
    .hidden{
    display:none
    }
</style>

<script>
    function disp(form) {
            $(form.nextElementSibling).fadeIn("slow", function(){
            });
    }
    </script>

<hr>
<button> <a href="/app/logout/">Выйти</a> </button>
<hr>

    <h1>Заявка № {{ info.id }} от : {{ info.time_in }}</h1>

    <table width="700"><tr>
        <td><h2>Заказчик: {{ info.customer_name }}  <a href="../list_order/update/{{ info.pk}}">изменить</a></h2></td>
    </tr>
        <tr>
        <td><b>Адрес: </b>{{ info.address_city|choice_tag:'city' }}, {{ info.address_street_app }}, {{ info.address_num }}</td>
    </tr>
    <tr>
         <td><b>Телефон:</b> {{ info.customer_phone }}</td>
    </tr>
    <tr>
         <td><b>Описание проблемы:</b> {{ info.text_order }}</td>
    </tr>
    </table>

<h3>Выполненные работы: </h3>
<table width="500" id="table_invoice">
 <tr>
            <th>Наименование </th>
            <th>Количество </th>
            <th>Цена</th>
            <th>Сумма</th>
            <th>----</th>
    </tr>


      <tr class="hidden">
            <td name="service_id"></td>
            <td name="quantity"></td>
            <td name="price"></td>
            <td name="amount">0</td>
            <td name="delete"><a href="" class="link-delete" >удалить</a></td>
    </tr>


{% for g in invoice %}

    <tr class="form_text">
            <td name="service_id">{{ g.service_id }} </td>
            <td name="quantity">{{ g.quantity }} </td>
            <td name="price">{{ g.price }}</td>
            <td name="amount">{{ g.amount }}</td>
            <td name="delete"><a href="{% url 'delete-item-of-order' g.pk %}" class="link-delete" >удалить</a></td>
    </tr>
{% endfor %}
    <tr id="total"><td></td></tr>
</table>

<form action="" method="post" id="id_form">
    {% csrf_token %}
    <div id="form-list">

        <div id="empty-form" class="hidden">
            <a href="#" onclick="disp(this)" >открыть</a>
            <span class="type_work">
            {% for u in type_work %}
                <a href="../serv?type_work={{ u.0 }}" class="type_work">{{ u.1 }}</a>
            {% endfor %}
            </span>
            <br> {{ form.empty_form }}
        </div>
        {{ form.management_form }}
    </div>
    <div id="error"></div>

    <button id="add-more" type="button">add-more</button>
    <button type="submit"> "Save" </button>

</form>

    <script>

    function sum_total() {
       var sum_total=0;
       $('td[name="amount"]').each(function(){sum_total += parseInt($(this).html());});
       $('#total').html('ИТОГО:'+ sum_total);
    }

    </script>
  <script>

        sum_total();
    </script>


<script>

    $('#id_form').submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: '',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'html',
            success: function (r) {
                var b=JSON.parse(r);
                console.log(b);
                if (b!=='error') {
                    var c = $('div[new="new"]');
                    for (i = 0; i < c.length; i++) {
                        var form_name = c[i]['id'];
                        var tr = $('tr.hidden').clone();
                        tr.find('td[name="service_id"]').html(b[i].service_id_name);
                        tr.find('td[name="quantity"]').html(b[i].quantity);
                        tr.find('td[name="price"]').html(b[i].price);
                        tr.find('td[name="amount"]').html(b[i].price*b[i].quantity);
                        tr.find('td[name="delete"]').html('<a href="/invoice/delete/'+b[i].pk+'" class="link-delete" >удалить</a>');
                        tr.attr('class','form_text')
                        $('#total').before(tr);
                        sum_total();
                    }
                    c.remove();
                    $('#id_form-TOTAL_FORMS').attr("value", 0);
                }
                else {$('#error').html('<h4>Заполните все поля</h4>');}
            },
        });

});
</script>


    <script>


$(document.body).on( "click", ".link-delete", function(e) {
        e.preventDefault();
        var $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(){
                        $this.parents(".form_text").fadeOut("slow", function(){
                        $this.parents(".form_text").remove();
                        sum_total()
                    });
            }
        });
    });


$(document.body).on( "click", "#status_order", function(e) {
        e.preventDefault();
        var $this=$(this);
        $.ajax({
            url: '',
            type: "GET",
            dataType: "json",
            success: function(e){
                       alert("__");
            },
            error: function(){
                       alert(e);
                       console.log(e);
            }
        });
    });


    $(document.body).on( "click", ".type_work", function(e) {
        e.preventDefault();
        var $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(b){
                        type=JSON.parse(b);
                        idname=$this.closest('div').find('select');
                        nametype='#'+idname.attr('name')+'_type_work';

                        $(idname).empty();
                        for (i = 0; i < type.length; i++) {
                            $(idname).append('<option value='+type[i].id+'>'+type[i].name+'</option>');
                        }

                        idh=$(nametype);
                        idh.fadeOut("slow", function(){   });

            }
        });
    });

       </script>



<script>
    const addMoreBtn=document.getElementById('add-more');
    const totalNewForms = document.getElementById('id_form-TOTAL_FORMS');
    addMoreBtn.addEventListener('click', add_new_form);

    function add_new_form(event){
        if (event) {
        event.preventDefault();
        }
        const currentForms = document.getElementsByClassName('form');

        const currentFormCount = currentForms.length ;

        const formCopyTarget = document.getElementById('form-list');
        const copyEmptyFromEl=document.getElementById('empty-form').cloneNode(true);
        copyEmptyFromEl.setAttribute('class', 'form');
        copyEmptyFromEl.setAttribute('id',`form-${currentFormCount}`);

        copyEmptyFromEl.setAttribute('new',`new`);

        copyEmptyFromEl.getElementsByClassName('type_work')[0].setAttribute('id',`form-${currentFormCount}-service_id_type_work`);

        const regex = new RegExp('__prefix__', 'g');
        copyEmptyFromEl.innerHTML=copyEmptyFromEl.innerHTML.replace(regex,
        currentFormCount);

        totalNewForms.setAttribute('value', currentFormCount+1);

        formCopyTarget.append(copyEmptyFromEl);

    }
</script>


<a href="pdf/{{ info.id }}">Квитанция на оплату - PDF</a>

{% endblock body %}
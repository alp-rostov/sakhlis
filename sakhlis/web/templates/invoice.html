{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}

{% block body %}
<style>
    .hidden{
    display:none
    }
</style>

<script>
    function show_type_work(form) {
            $(form.nextElementSibling).fadeIn("slow", function(){
            });
    }
    </script>

<br>
{% if prev.pk %}
<p align="center" class="mycolor">
<a href="{% url 'invoice' prev.pk %}" class="mycolor"><--</a>||
{% endif %}

{% if next.pk %}
<a href="{% url 'invoice' next.pk %}" class="mycolor">--></a>
{% endif %}
</p>

<h2 class="h1-responsive">Заявка № {{ info.id }}<br>{{ info.time_in }}</h2>

{% if info.order_status == 'SND' %}
<p  >статус заказа: <b id="stepstatuswork">Направлен мастеру </b>  ->
<a href="../changestatus?order_pk={{ info.pk}}&work_status=RCV" id="workstatus">ПРИНЯТЬ ЗАКАЗ</a><br>
</p>
{% endif %}

{% if info.order_status == 'RCV' %}
<p  >статус заказа: <b id="stepstatuswork">Заявка в работе</b>
    <a href="../changestatus?order_pk={{ info.pk}}&work_status=END" id="workstatus">Работы выполненны</a><br>

</p>

{% endif %}

{% if info.order_status == 'END' %}
<p  >статус заказа: <b id="stepstatuswork">Работы выполнены</b>

</p>


{% endif %}

<br>
    <table width="700"><tr>
        <td>Заказчик: {{ info.customer_name }}  <a href="../list_order/update/{{ info.pk}}">изменить</a></td>
    </tr>
        <tr>
        <td><b>Адрес: </b>{{ info.address_city|choice_tag:'city' }}, {{ info.address_street_app }}, {{ info.address_num }}</td>
    </tr>
    <tr>
         <td><b>Телефон:</b>{{ info.customer_phone }}</td>
    </tr>
    <tr>
         <td><b>Описание проблемы:</b> {{ info.text_order }}</td>
    </tr>
    </table>

{% if info.order_status == 'SND' %}
<table width="500" id="table_invoice" class="hidden">
{% else %}
<table width="500" id="table_invoice">
{% endif %}
    <tr clospan="5"><td><h4>Выполненные работы: </h4></td></tr>
 <tr>
            <th>Наименование </th>
            <th>Количество </th>
            <th>Цена</th>
            <th>Сумма</th>
            <th>----</th>
    </tr>


      <tr class="hidden">
            <td name="service_id"></td>
            <td name="quantity"></td>
            <td name="price"></td>
            <td name="amount">0</td>
            <td name="delete"><a href="" class="link-delete" >удалить</a></td>
    </tr>


{% for g in invoice %}

    <tr class="form_text">
            <td name="service_id">{{ g.service_id }} </td>
            <td name="quantity">{{ g.quantity }} </td>
            <td name="price">{{ g.price }}</td>
            <td name="amount">{{ g.amount }}</td>
            <td name="delete"><a href="{% url 'delete-item-of-order' g.pk %}" class="link-delete" >удалить</a></td>
    </tr>
{% endfor %}
    <tr id="total"><td></td></tr>



</table>

{% if info.order_status == 'SND' %}
<form action="" method="post" id="id_form" class="hidden">
{% else %}
<form action="" method="post" id="id_form" >
{% endif %}

    {% csrf_token %}
    <div id="form-list">

        <div id="empty-form" class="hidden">
            <a href="#" onclick="show_type_work(this)" >открыть</a>
            <span class="type_work">
            {% for u in type_work %}
                <a href="../serv?type_work={{ u.0 }}" class="type_work">{{ u.1 }}</a>
            {% endfor %}
            </span>
            <br> {{ form.empty_form }}<a href="#" id="delete-empty-form">удалить</a>
        </div>
        {{ form.management_form }}
    </div>
    <div id="error"></div>

    <button id="add-more" type="button">add-more</button>
    <button type="submit"> "Save" </button><br>
<a href="pdf/{{ info.id }}">Квитанция на оплату - PDF</a>
</form>

    <script>

    function sum_total() {
       let sum_total=0;
       $('td[name="amount"]').each(function(){sum_total += parseInt($(this).html());});
       $('#total').html('ИТОГО:'+ sum_total);
    }

    </script>
  <script>

        sum_total();
    </script>


<script>

    $('#id_form').submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: '',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'html',
            success: function (r) {
                let b=JSON.parse(r);
                console.log(b);
                if (b!=='error') {
                    let c = $('div[new="new"]');
                    for (i = 0; i < c.length; i++) {
                        let form_name = c[i]['id'];
                        let tr = $('tr.hidden').clone();
                        tr.find('td[name="service_id"]').html(b[i].service_id_name);
                        tr.find('td[name="quantity"]').html(b[i].quantity);
                        tr.find('td[name="price"]').html(b[i].price);
                        tr.find('td[name="amount"]').html(b[i].price*b[i].quantity);
                        tr.find('td[name="delete"]').html('<a href="/invoice/delete/'+b[i].pk+'" class="link-delete" >удалить</a>');
                        tr.attr('class','form_text')
                        $('#total').before(tr);
                        sum_total();
                    }
                    c.remove();
                    $('#id_form-TOTAL_FORMS').attr("value", 0);
                }
                else {$('#error').html('<h4>Заполните все поля</h4>');}
            },
        });

});
</script>


    <script>


$(document.body).on( "click", ".link-delete", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(){
                        $this.parents(".form_text").fadeOut("slow", function(){
                        $this.parents(".form_text").remove();
                        sum_total()
                    });
            }
        });
    });






$(document.body).on( "click", "#workstatus", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(r){
                        let b=r.message;
                        console.log(b);
                        if (b=='RCV') {

                            $('#stepstatuswork').html('Заявка в работе');
                            $('#workstatus').html('Работы выполнены');
                            $('#workstatus').attr('href', "../changestatus?order_pk={{ info.pk}}&work_status=END");
                            $('#id_form').attr('class', '');
                            $('#table_invoice').attr('class', '');

                        } else
                        if (b=='END') {
                            $('#workstatus').remove();
                            $('#stepstatuswork').html('Работы выполнены');
                        }

                        console.log



            }
        });
    });









    $(document.body).on( "click", "#delete-empty-form", function(e) {
        e.preventDefault();
        let $this=$(this);
        $this.parents(".form").remove();
    });

    $(document.body).on( "click", ".type_work", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(b){
                        let type=JSON.parse(b);
                        let idname=$this.closest('div').find('select');
                        let nametype='#'+idname.attr('name')+'_type_work';

                        $(idname).empty();
                        for (i = 0; i < type.length; i++) {
                            $(idname).append('<option value='+type[i].id+'>'+type[i].name+'</option>');
                        }

                        idh=$(nametype);
                        idh.fadeOut("slow", function(){   });

            }
        });
    });

       </script>



<script>
    const addMoreBtn=document.getElementById('add-more');
    const totalNewForms = document.getElementById('id_form-TOTAL_FORMS');
    addMoreBtn.addEventListener('click', add_new_form);

    function add_new_form(event){
        if (event) {
        event.preventDefault();
        }
        const currentForms = document.getElementsByClassName('form');

        const currentFormCount = currentForms.length ;

        const formCopyTarget = document.getElementById('form-list');
        const copyEmptyFromEl=document.getElementById('empty-form').cloneNode(true);
        copyEmptyFromEl.setAttribute('class', 'form');
        copyEmptyFromEl.setAttribute('id',`form-${currentFormCount}`);

        copyEmptyFromEl.setAttribute('new',`new`);

        copyEmptyFromEl.getElementsByClassName('type_work')[0].setAttribute('id',`form-${currentFormCount}-service_id_type_work`);

        const regex = new RegExp('__prefix__', 'g');
        copyEmptyFromEl.innerHTML=copyEmptyFromEl.innerHTML.replace(regex,
        currentFormCount);

        totalNewForms.setAttribute('value', currentFormCount+1);

        formCopyTarget.append(copyEmptyFromEl);

    }
</script>





        {% endblock body %}
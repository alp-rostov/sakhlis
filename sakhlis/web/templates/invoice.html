{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}

{% block body %}


<style>
    .hidden{
    display:none
    }

</style>

<script>
    function show_type_work(form) {
            $(form.nextElementSibling).fadeIn("slow", function(){
            });
    }
    </script>




<div class="container">
    <div class="row">
        <div class="col-md-12" align="center">
        {% if prev.pk %}
            <a href="{% url 'invoice' prev.pk %}" class="btn"><</a>
        {% endif %}
        {% if next.pk %}
            <a href="{% url 'invoice' next.pk %}" class="btn">></a>
        {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 h4 text-center" align="center">
            Заявка № {{ info.id }}<br>{{ info.time_in }}

        </div>
   </div>

    <div class="row">
        <div class="col-md-12 h6 text-center" align="center">
                  {% if info.order_status == 'SND' %}
            <p align="center"><b id="stepstatuswork">Заявка направлена мастеру </b>  <br>
            <a href="../changestatus?order_pk={{ info.pk}}&work_status=RCV" id="workstatus"
               class="btn btn-md btn-orange" >ПРИНЯТЬ ЗАКАЗ</a><br>
            </p>
            {% endif %}

            {% if info.order_status == 'RCV' %}
            <p align="center"><b id="stepstatuswork">Заявка в работе</b><br>
                <a href="../changestatus?order_pk={{ info.pk}}&work_status=END" id="workstatus" class="btn btn-md btn-orange">Работы выполненны</a><br>
            </p>

            {% endif %}

            {% if info.order_status == 'END' %}
            <p align="center"><b id="stepstatuswork"><i class="fas fa-check-circle about-text"></i> Работы выполнены</b><br>
                <a href="pdf/{{ info.id }}" class="btn btn-md btn-orange">Квитанция на оплату - PDF</a>

            </p>


            {% endif %}

        </div>
   </div>
</div>


<div>
    <div class="row">
        <div class="col-md-4">Заказчик:</div><div class="col-md-6"> {{ info.customer_name }}
        </div>
        <div class="col-md-2" >
        <a href="../list_order/update/{{ info.pk}}" class="fas fa-pen text fa-sm mr-1 btn "></a></div>
                        </a></div>
    </div>
     <div class="row">
            <div class="col-md-12"><hr></div>
        </div>
    <div class="row">
        <div class="col-md-4">Адрес:</div><div class="col-md-6">{{ info.address_city|choice_tag:'city' }}, {{ info.address_street_app }}, {{ info.address_num }}</div>
        <div class="col-md-2" >
        <a href= 'https://yandex.ru/maps/?pt={{ info.location_longitude|change_comma_to_dot }},
                    {{ info.location_latitude|change_comma_to_dot }}&z=18&l=map' id="map_{{ i.pk }}"
           title="" class="fas fa-map-marker text fa-sm mr-1 btn">
                        </a></div>

    </div>
     <div class="row">
            <div class="col-md-12"><hr></div>
    </div>
    <div class="row">
         <div class="col-md-4">Телефон:</div><div class="col-md-6" >{{ info.customer_phone }}</div>
        <div class="col-md-2" >
        <a href="tel:{{ info.customer_phone }}" title="Телефон" class="fas fa-phone text fa-sm mr-1 btn">
                        </a></div>
    </div>
     <div class="row">
            <div class="col-md-12"><hr></div>
    </div>
    <div class="row">
         <div class="col-md-4">Телеграм:</div><div class="col-md-6">@{{ info.customer_telegram }}</div>
        <div class="col-md-2">
    <a href="https://t.me/{{ info.customer_telegram|cut:'@' }}" title="Телеграм" class="fas fa-paper-plane text fa-sm mr-1 btn">
                        </a>
        </div>
    </div>
     <div class="row">
        <div class="col-md"><hr></div>
     </div>
    <div class="row">
         <div class="col-md-4">Описание проблемы:</div><div class="col-md-8"> {{ info.text_order }}</div>
    </div>
    </div>
 <div class="row">
        <div class="col-md"><hr></div>
     </div>

{% if info.order_status == 'SND' %}
<table id="table_invoice" class="hidden">
{% else %}
<table id="table_invoice" class="table" >
{% endif %}
<thead>
 <tr  class="table-warning">
            <th>Наименование </th>
            <th>Количество </th>
            <th>Цена</th>
            <th >Сумма</th>
            <th > </th>
    </tr>
</thead>

      <tr class="hidden">
            <td name="service_id"></td>
            <td name="quantity"></td>
            <td name="price"></td>
            <td name="amount">0</td>
            <td name="delete"><a href="" class="link-delete" ><img src="/media/images/delete.png" width="15" ></a></td>
    </tr>

<tbody>
{% for g in invoice %}

    <tr class="form_text">
            <td name="service_id">{{ g.service_id }}</td>
            <td name="quantity">{{ g.quantity }} </td>
            <td name="price">{{ g.price }}</td>
            <td name="amount">{{ g.amount }}</td>
            <td name="delete"><a href="{% url 'delete-item-of-order' g.pk %}" class="link-delete" ><img src="/media/images/delete.png" width="15"></a></td>
    </tr>
{% endfor %}
<tbody>
    <tr class="table-warning" id="total_">


<th></th><th class="h5-responsive" ></th>
            <th class="h5-responsive "  >Итого: </th>
            <th class="h5-responsive" id="total" > </th><th></th>
            </tr>

</table>





{% if info.order_status == 'SND' %}
<form action="" method="post" id="id_form" class="hidden">
{% else %}
<form action="" method="post" id="id_form" >
{% endif %}

    {% csrf_token %}
    <div id="form-list">

        <div id="empty-form" class="hidden">
            <a href="#" onclick="show_type_work(this)" class="btn btn-sm">открыть</a>
            <span class="type_work">
            {% for u in type_work %}
                <a href="../serv?type_work={{ u.0 }}" class="type_work btn btn-sm">{{ u.1 }}</a>
            {% endfor %}
            </span>
            <br> {{ form.empty_form }}<a href="#" id="delete-empty-form"><img src="/media/images/delete.png" width="15"></a>
        </div>
        {{ form.management_form }}
    </div>
    <div id="error"></div>
    <div align="center">
        <button id="add-more" type="button" class="btn btn-md btn-orange">add-more</button>
        <button type="submit" class="btn btn-md btn-orange"> "Save" </button><br>
    </div>>

</form>

    <script>

    function sum_total() {
       let sum_total=0;
       $('td[name="amount"]').each(function(){sum_total += parseInt($(this).html());});
       $('#total').html(sum_total);
    }

    </script>
  <script>

        sum_total();
    </script>


<script>

    $('#id_form').submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: '',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'html',
            success: function (r) {
                let b=JSON.parse(r);
                console.log(b);
                if (b!=='error') {
                    let c = $('div[new="new"]');
                    for (i = 0; i < c.length; i++) {
                        let form_name = c[i]['id'];
                        let tr = $('tr.hidden').clone();
                        tr.find('td[name="service_id"]').html(b[i].service_id_name);
                        tr.find('td[name="quantity"]').html(b[i].quantity);
                        tr.find('td[name="price"]').html(b[i].price);
                        tr.find('td[name="amount"]').html(b[i].price*b[i].quantity);
                        tr.find('td[name="delete"]').html('<a href="/invoice/delete/'+b[i].pk+'" class="link-delete" ><img src="/media/images/delete.png" width="15"></a>');
                        tr.attr('class','form_text')
                        $('#total_').before(tr);
                        sum_total();
                    }
                    c.remove();
                    $('#id_form-TOTAL_FORMS').attr("value", 0);
                }
                else {$('#error').html('<h4>Заполните все поля</h4>');}
            },
        });

});
</script>


    <script>


$(document.body).on( "click", ".link-delete", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(){
                        $this.parents(".form_text").fadeOut("slow", function(){
                        $this.parents(".form_text").remove();
                        sum_total()
                    });
            }
        });
    });






$(document.body).on( "click", "#workstatus", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(r){
                        let b=r.message;
                        console.log(b);
                        if (b=='RCV') {

                            $('#stepstatuswork').html('Заявка в работе');
                            $('#workstatus').html('Работы выполнены');
                            $('#workstatus').attr('href', "../changestatus?order_pk={{ info.pk}}&work_status=END");
                            $('#id_form').attr('class', '');
                            $('#table_invoice').attr('class', 'table');

                        } else
                        if (b=='END') {
                            $('#workstatus').remove();
                            $('#stepstatuswork').html('<i class="fas fa-check-circle about-text"></i> Работы выполнены<br><a href="pdf/{{ info.id }}" class="btn btn-md btn-orange">Квитанция на оплату - PDF</a>');



                        }

                        console.log



            }
        });
    });









    $(document.body).on( "click", "#delete-empty-form", function(e) {
        e.preventDefault();
        let $this=$(this);
        $this.parents(".form").remove();
    });

    $(document.body).on( "click", ".type_work", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(b){
                        let type=JSON.parse(b);
                        let idname=$this.closest('div').find('select');
                        let nametype='#'+idname.attr('name')+'_type_work';

                        $(idname).empty();
                        for (i = 0; i < type.length; i++) {
                            $(idname).append('<option value='+type[i].id+'>'+type[i].name+'</option>');
                        }

                        idh=$(nametype);
                        idh.fadeOut("slow", function(){   });

            }
        });
    });







       </script>



<script>
    const addMoreBtn=document.getElementById('add-more');
    const totalNewForms = document.getElementById('id_form-TOTAL_FORMS');
    addMoreBtn.addEventListener('click', add_new_form);

    function add_new_form(event){
        if (event) {
        event.preventDefault();
        }
        const currentForms = document.getElementsByClassName('form');

        const currentFormCount = currentForms.length ;

        const formCopyTarget = document.getElementById('form-list');
        const copyEmptyFromEl=document.getElementById('empty-form').cloneNode(true);
        copyEmptyFromEl.setAttribute('class', 'form');
        copyEmptyFromEl.setAttribute('id',`form-${currentFormCount}`);

        copyEmptyFromEl.setAttribute('new',`new`);

        copyEmptyFromEl.getElementsByClassName('type_work')[0].setAttribute('id',`form-${currentFormCount}-service_id_type_work`);

        const regex = new RegExp('__prefix__', 'g');
        copyEmptyFromEl.innerHTML=copyEmptyFromEl.innerHTML.replace(regex,
        currentFormCount);

        totalNewForms.setAttribute('value', currentFormCount+1);

        formCopyTarget.append(copyEmptyFromEl);

    }
</script>





        {% endblock body %}
{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}

{% block body %}
<style>
    .hidden{
    display:none
    }

</style>

<script>
    function show_type_work(form) {
<style>
    .hidden{
    display:none
    }
</style>

<a href="#----"  onclick="show_create_order_form(document.getElementById('form'))"
                      id="link_create_order_form">Создать заказ</a> |

{% if request.GET.work_status == 'SND' %}
<a href="{% url 'list_order' %}?work_status=SND"><b>Новые заказы</b></a> |
{% else %}
<a href="{% url 'list_order' %}?work_status=SND">Новые заказы</a> |
{% endif %}

{% if request.GET.work_status == 'RCV' %}
<a href="{% url 'list_order'%}?work_status=RCV"><b>Заявки в работе</b></a> |
{% else %}
<a href="{% url 'list_order'%}?work_status=RCV">Заявки в работе</a> |
{% endif %}

{% if request.GET.work_status == 'END' %}
<a href="{% url 'list_order'%}?work_status=END"><b>Заявки окноченные</b></a>|
{% else %}
<a href="{% url 'list_order'%}?work_status=END">Заявки окноченные</a>|
{% endif %}
            $(form.nextElementSibling).fadeIn("slow", function(){
            });
    }
    </script>



<table  width="300">
    <tr><td>{% if prev.pk %}
    <a href="{% url 'invoice' prev.pk %}" class="btn"><</a>
{% endif %}
    </td>

    <td align="center" class="h6-responsive">
Заявка № {{ info.id }}<br>{{ info.time_in }}
    </td>
        <td>

       {% if next.pk %}
            <a href="{% url 'invoice' next.pk %}" class="btn">></a>
{% endif %}

    </td></tr>
</table>
<br>


{% if info.order_status == 'SND' %}
<p><b id="stepstatuswork">Заявка направлена мастеру </b>  <br>
<a href="../changestatus?order_pk={{ info.pk}}&work_status=RCV" id="workstatus"
   class="btn btn-md btn-orange" >ПРИНЯТЬ ЗАКАЗ</a><br>
</p>
{% endif %}

{% if info.order_status == 'RCV' %}
<p><b id="stepstatuswork">Заявка в работе</b><br>
    <a href="../changestatus?order_pk={{ info.pk}}&work_status=END" id="workstatus" class="btn btn-md btn-orange">Работы выполненны</a><br>


</p>

{% endif %}

{% if info.order_status == 'END' %}
<p><b id="stepstatuswork"><i class="fas fa-check-circle about-text"></i> Работы выполнены</b><br>
    <a href="pdf/{{ info.id }}" class="btn btn-md btn-orange">Квитанция на оплату - PDF</a>

</p>


{% endif %}

<br>
    <table class="table" ><tr>
        <td>Заказчик:</td><td> {{ info.customer_name }}  <a href="../list_order/update/{{ info.pk}}"><img src="/media/images/change.png" width="25" ></a></td>
    </tr>
        <tr>
        <td><b>Адрес: </b></td><td>{{ info.address_city|choice_tag:'city' }}, {{ info.address_street_app }}, {{ info.address_num }}</td>
    </tr>
    <tr>
         <td><b>Телефон:</b></td><td>{{ info.customer_phone }}
        <a href="tel:{{ info.customer_phone }}" title="Телефон" class="fas fa-phone text-danger fa-sm mr-1">
                        </a></td>
    </tr>
    <tr>
         <td><b>Телеграм:</b></td><td>@{{ info.customer_telegram }}
    <a href="https://t.me/{{ info.customer_telegram|cut:'@' }}" title="Телеграм">
                        <img src="/static/images/telegram.gif" width="25"></a>
        </td>
    </tr>

    <tr>
         <td><b>Описание проблемы:</b></td><td> {{ info.text_order }}</td>
    </tr>
    </table>

{% if info.order_status == 'SND' %}
<table id="table_invoice" class="hidden">
{% else %}
<table id="table_invoice" class="table" >
{% endif %}

 <tr  class="table-warning">
            <th>Наименование </th>
            <th>Количество </th>
            <th>Цена</th>
            <th >Сумма</th>
            <th > </th>
    </tr>


      <tr class="hidden">
            <td name="service_id"></td>
            <td name="quantity"></td>
            <td name="price"></td>
            <td name="amount">0</td>
            <td name="delete"><a href="" class="link-delete" ><img src="/media/images/delete.png" width="15" ></a></td>
    </tr>


{% for g in invoice %}

    <tr class="form_text">
            <td name="service_id">{{ g.service_id }} </td>
            <td name="quantity">{{ g.quantity }} </td>
            <td name="price">{{ g.price }}</td>
            <td name="amount">{{ g.amount }}</td>
            <td name="delete"><a href="{% url 'delete-item-of-order' g.pk %}" class="link-delete" ><img src="/media/images/delete.png" width="15"></a></td>
    </tr>
{% endfor %}

    <tr class="table-warning" id="total_">


<th></th><th class="h5-responsive" ></th>
            <th class="h5-responsive "  >Итого: </th>
            <th class="h5-responsive" id="total" > </th><th></th>
            </tr>

</table>





{% if info.order_status == 'SND' %}
<form action="" method="post" id="id_form" class="hidden">
{% else %}
<form action="" method="post" id="id_form" >
{% endif %}

    {% csrf_token %}
    <div id="form-list">

        <div id="empty-form" class="hidden">
            <a href="#" onclick="show_type_work(this)" >открыть</a>
            <span class="type_work">
            {% for u in type_work %}
                <a href="../serv?type_work={{ u.0 }}" class="type_work">{{ u.1 }}</a>
            {% endfor %}
            </span>
            <br> {{ form.empty_form }}<a href="#" id="delete-empty-form"><img src="/media/images/delete.png" width="15"></a>
        </div>
        {{ form.management_form }}
    </div>
    <div id="error"></div>

    <button id="add-more" type="button" class="btn btn-md btn-orange">add-more</button>
    <button type="submit" class="btn btn-md btn-orange"> "Save" </button><br>


</form>

    <script>

    function sum_total() {
       let sum_total=0;
       $('td[name="amount"]').each(function(){sum_total += parseInt($(this).html());});
       $('#total').html(sum_total);
    }

    </script>
  <script>

        sum_total();
    </script>


<script>

    $('#id_form').submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: '',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'html',
            success: function (r) {
                let b=JSON.parse(r);
                console.log(b);
                if (b!=='error') {
                    let c = $('div[new="new"]');
                    for (i = 0; i < c.length; i++) {
                        let form_name = c[i]['id'];
                        let tr = $('tr.hidden').clone();
                        tr.find('td[name="service_id"]').html(b[i].service_id_name);
                        tr.find('td[name="quantity"]').html(b[i].quantity);
                        tr.find('td[name="price"]').html(b[i].price);
                        tr.find('td[name="amount"]').html(b[i].price*b[i].quantity);
                        tr.find('td[name="delete"]').html('<a href="/invoice/delete/'+b[i].pk+'" class="link-delete" ><img src="/media/images/delete.png" width="15"></a>');
                        tr.attr('class','form_text')
                        $('#total_').before(tr);
                        sum_total();
                    }
                    c.remove();
                    $('#id_form-TOTAL_FORMS').attr("value", 0);
                }
                else {$('#error').html('<h4>Заполните все поля</h4>');}
            },
        });

});
</script>


    <script>


$(document.body).on( "click", ".link-delete", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(){
                        $this.parents(".form_text").fadeOut("slow", function(){
                        $this.parents(".form_text").remove();
                        sum_total()
                    });
            }
        });
    });






$(document.body).on( "click", "#workstatus", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(r){
                        let b=r.message;
                        console.log(b);
                        if (b=='RCV') {

                            $('#stepstatuswork').html('Заявка в работе');
                            $('#workstatus').html('Работы выполнены');
                            $('#workstatus').attr('href', "../changestatus?order_pk={{ info.pk}}&work_status=END");
                            $('#id_form').attr('class', '');
                            $('#table_invoice').attr('class', 'table');

                        } else
                        if (b=='END') {
                            $('#workstatus').remove();
                            $('#stepstatuswork').html('<i class="fas fa-check-circle about-text"></i> Работы выполнены<br><a href="pdf/{{ info.id }}" class="btn btn-md btn-orange">Квитанция на оплату - PDF</a>');



                        }

                        console.log



            }
        });
    });









    $(document.body).on( "click", "#delete-empty-form", function(e) {
        e.preventDefault();
        let $this=$(this);
        $this.parents(".form").remove();
    });

    $(document.body).on( "click", ".type_work", function(e) {
        e.preventDefault();
        let $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(b){
                        let type=JSON.parse(b);
                        let idname=$this.closest('div').find('select');
                        let nametype='#'+idname.attr('name')+'_type_work';

                        $(idname).empty();
                        for (i = 0; i < type.length; i++) {
                            $(idname).append('<option value='+type[i].id+'>'+type[i].name+'</option>');
                        }

                        idh=$(nametype);
                        idh.fadeOut("slow", function(){   });

            }
        });
    });

       </script>



<script>
    const addMoreBtn=document.getElementById('add-more');
    const totalNewForms = document.getElementById('id_form-TOTAL_FORMS');
    addMoreBtn.addEventListener('click', add_new_form);

    function add_new_form(event){
        if (event) {
        event.preventDefault();
        }
        const currentForms = document.getElementsByClassName('form');

        const currentFormCount = currentForms.length ;

        const formCopyTarget = document.getElementById('form-list');
        const copyEmptyFromEl=document.getElementById('empty-form').cloneNode(true);
        copyEmptyFromEl.setAttribute('class', 'form');
        copyEmptyFromEl.setAttribute('id',`form-${currentFormCount}`);

        copyEmptyFromEl.setAttribute('new',`new`);

        copyEmptyFromEl.getElementsByClassName('type_work')[0].setAttribute('id',`form-${currentFormCount}-service_id_type_work`);

        const regex = new RegExp('__prefix__', 'g');
        copyEmptyFromEl.innerHTML=copyEmptyFromEl.innerHTML.replace(regex,
        currentFormCount);

        totalNewForms.setAttribute('value', currentFormCount+1);

        formCopyTarget.append(copyEmptyFromEl);

    }
</script>





        {% endblock body %}
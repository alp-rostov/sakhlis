{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}

{% block body %}
<style>
    .hidden{
    display:none
    }
</style>
<hr>
<button> <a href="/app/logout/">Выйти</a> </button>
<hr>



    <h1>Заявка № {{ info.id }} от : {{ info.time_in }}</h1>

    <table width="700"><tr>
        <td><h2>Заказчик: {{ info.customer_name }}  <a href="#" id="name">изменить</a></h2></td>
    </tr>
        <tr>
        <td><b>Адрес: </b>{{ info.address_city }}, {{ info.address_street_app }}, {{ info.address_num }}</td>
    </tr>
    <tr>
         <td><b>Телефон:</b> {{ info.customer_phone }}</td>
    </tr>
    <tr>
         <td><b>Описание проблемы:</b> {{ info.text_order }}</td>
    </tr>
    </table>


<h3>Выполненные работы: </h3>
<form action="" method="post" id="id_form">
{% csrf_token %}
{{ form.management_form }}
    <div id="ingredient-form-list">
        <script>
            var i=0;
            var sum=0;
        </script>
        {% for g in form %}
        <div class="ingredient-form">

                {{ g.as_table }}



               <script>
                    price=$('#'+'id_form-'+i+'-price').val();
                    quantity=$('#'+'id_form-'+i+'-quantity').val();
                    sum+=price*quantity
                    i++;
                    $('#'+'id_form-'+i+'-price').
                    after(
                        document.write(
                            '<input type="text" value='+price*quantity+
                            ' readonly size=3 name="amount">'
                        )
                    );
               </script>

            <a href="{% url 'delete-item-of-work' g.id.value %}" class="link-delete">удалить</a>
            <br>
        </div>
        {% endfor %}
        <span id="uuu"></span>
        <script>
            document.write('ИТОГО: '+ sum);
        </script>
    </div>
    <div id="empty-form" class="hidden">{{ form.empty_form }}</div>
    <button id="add-more" type="button">add-more</button>
    <button type="submit"> "Save" </button>

</form>



<script>

    $('#id_form').submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: '',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'html',
            success: function (r) {
                b=JSON.parse(r);
                c = $('div[new="new"]');

                for (i = 0; i < c.length; i++) {
                    form_name = c[i]['id'];
                    $("#id_" + form_name + "-quantity").attr("value", b[i].quantity);
                    $("#id_" + form_name + "-price").attr("value", b[i].price);
                    $("#id_" + form_name + "-id").attr("value", b[i].pk);
                    amount=b[i].price*b[i].quantity;
                    $("#id_" + form_name + "-price").after(
                    ' <input type="text" value='+amount+' readonly size=3 name="amount">'+
                    '<a href="/invoice/delete/'+b[i].pk+'" class="link-delete">удалить</a>');

                }
                c.attr("new", "-");
                ff = $('#id_form-TOTAL_FORMS').attr("value");

                $('#id_form-INITIAL_FORMS').attr("value", ff );



            },
        });

});
</script>



    <script>

    $('.link-delete').on('click', function(e) {
        e.preventDefault();
        var $this=$(this);
        $.ajax({
            url: $this.attr("href"),
            type: "GET",
            dataType: "json",
            success: function(re){
                    $this.parents(".ingredient-form").fadeOut("slow", function(){
                        $this.parents(".ingredient-form").remove();
                    });
            }
        });
    });

       </script>



<script>
    const addMoreBtn=document.getElementById('add-more')
    const totalNewForms = document.getElementById('id_form-TOTAL_FORMS')
    addMoreBtn.addEventListener('click', add_new_form)

    function add_new_form(event){
        if (event) {
        event.preventDefault()
        }
        const currentIngredientForms = document.getElementsByClassName('ingredient-form')
        const currentFormCount = currentIngredientForms.length // + 1
        const formCopyTarget = document.getElementById('ingredient-form-list')
        const copyEmptyFromEl=document.getElementById('empty-form').cloneNode(true)
        copyEmptyFromEl.setAttribute('class', 'ingredient-form')
        copyEmptyFromEl.setAttribute('id',`form-${currentFormCount}`)
        copyEmptyFromEl.setAttribute('new',`new`)
        const regex = new RegExp('__prefix__', 'g')
        copyEmptyFromEl.innerHTML=copyEmptyFromEl.innerHTML.replace(regex,
         currentFormCount)
        totalNewForms.setAttribute('value', currentFormCount+1)
        formCopyTarget.append(copyEmptyFromEl)
    }
</script>


<!--<h3>Статус заказа: {{ info.order_status  | choice_tag:'status_order'}}</h3>-->


<!--{% if info.order_status == 'END' %}-->
<!--    <a href="pdf/{{ info.id }}">Квитанция на оплату - PDF</a>-->
<!--{% else %}-->
<!--    <a href="">Заказ выполненен - указать статус заказа</a>-->

<!--{% endif %}-->
<span id="eee"></span>
{% endblock body %}
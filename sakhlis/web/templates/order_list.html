{% extends 'flatpages/default_user.html' %}
{% load custom_filters %}
{% load custom_tags %}


{% block body %}
<style>
    .hidden{
    display:none
    }
</style>

<h2>Список заказов <a href="#"  onclick="disp(document.getElementById('form'))" id="ggg">Создать заказ</a></h2>
<hr>
<a href="{% url 'list_order' %}">Текущие заказы</a> | <a href="{% url 'list_order'%}?end=true">Выполненные работы</a>
<hr>




<script>
    function disp(form) {
        if (form.style.display == "none") {
            $('#form').fadeIn("slow", function(){
                form.style.display = "block";
                $('#ggg').html('Скрыть');
                                        });

        } else {
             $('#form').fadeOut("slow", function(){
                form.style.display = "none";
                $('#ggg').html('Создать заказ');
                                        });
        }
    }
    </script>



 <form method="post" action="" name="form" id="form"  style="display: none;">
        {% csrf_token %}
        <div class="md-form mb-4">

            {{ form.customer_name.errors }}
            {{ form.customer_name }}
            <span id="0"></span>
        </div>
       <div class="md-form mb-4">

            {{ form.customer_phone.errors }}
            {{ form.customer_phone }}
            <span id="1"></span>
        </div>
        <div class="md-form mb-4">

            {{ form.customer_street_app.errors }}
            {{ form.customer_num.errors }}
            {{ form.address_street_app }}
            <span id="2"></span>
            {{ form.address_num }}
            <span id="3"></span>
        </div>
        <div class="md-form mb-4">

            {{ form.text_order.errors }}
            {{ form.text_order }}
            <span id="4"></span>
        </div>


     <button type="submit" name="submit">Отправить заявку</button>
    </form>
     <script type="text/javascript">
             $(document).ready(function() {

                                $('#form').submit(function(e) {
                                    e.preventDefault();
                                    var d=$("form input[type='text'], input[type='tel']")
                                    var check=false;
                                    for (i=0; i<d.length; i++){
                                        $('form #'+i).html('');
                                        if (d[i].value=='') {
                                            $('form #'+i).html('Введите данные поля "' +d[i].placeholder + '"' );
                                        check=true;
                                        }
                                    }
                                    if (check) {
                                        return false;
                                    } else {
                                        $.ajax({
                                            url: '../',
                                            type: 'POST',
                                            data: $(this).serialize(),
                                            dataType: 'text',
                                            beforeSend: function () {$("#id_form").html('<h3>Отправляется...</h3>');},
                                            success: function (resp) {
                                                                    r=JSON.parse(resp);

                                                                    g=$("#row_").clone();
                                                                    g.attr("class", "");
                                                                    g.attr("id", "row_"+r.num_order);

                                                                    g.find("#order_").attr("href", "invoice/"+r.num_order);
                                                                    g.find("#order_").html("Заказ №"+r.num_order);
                                                                    g.find("#order_").attr("id", "order_"+r.num_order);

                                                                    g.find("#delete_").attr("href", "invoice/delete-order/"+r.num_order);
                                                                    g.find("#delete_").attr("id", "delete_"+r.num_order);

                                                                    g.find("#text_order_").html(r.text_order);
                                                                    g.find("#text_order_").attr("id", "text_order_"+r.num_order);

                                                                    g.find("#customer_name_").html(r.customer_name);
                                                                    g.find("#customer_name_").attr("id", "customer_name_"+r.num_order);

                                                                    g.find("#customer_phone_").html(r.customer_phone);
                                                                    g.find("#customer_phone_").attr("id", "customer_phone_"+r.num_order);

                                                                    g.find("#city_").html(r.city);
                                                                    g.find("#city_").attr("id", "city_"+r.num_order);

                                                                    g.find("#street_app_").html(r.street);
                                                                    g.find("#street_app_").attr("id", "street_app_"+r.num_order);

                                                                    g.find("#num_").html(r.num);
                                                                    g.find("#num_").attr("id", "num_"+r.num_order);

                                                                    $('#head').prepend(g);

                                                                    disp(document.getElementById('form'))
                                                                    $('#form')[0].reset();
                                                                       },
                                        });
                                    }
                                });
                            });
                            </script>



<table id="head">


{% regroup order by time_in|date:"d.m.Y" as day %}
    {% for y in day reversed  %}
    <tr>
        <td  colspan="6">
            <b>{{ y.grouper }}</b>
        </td>
    <tr>

        {% for i in y.list reversed %}
        <tr id="row_{{ i.pk }}" >

                {% if i.order_status == 'SND' %}
                <td bgcolor= "#DCDCDC">
                {% else %} <td>
                {% endif %}


                <a href="{% url 'invoice' i.pk %}" id="order_{{ i.pk }}">Заказ №{{ i.pk}}</a>

                <a href="{% url 'delete-order' i.pk %}" id="delete_{{ i.pk }}">Удалить</a><br>
                <span id="text_order_{{ i.pk }}">{{ i.text_order|truncatewords:7 }}</span>
            </td>
            <td width = 50></td>
            <td><span id="customer_name_{{ i.pk }}">{{ i.customer_name }}</span>> |
                <span id="customer_phone_{{ i.pk }}">{{ i.customer_phone }}</span><br>
                <span id="city_{{ i.pk }}">{{ i.address_city}}</span>,
                <span id="street_app_{{ i.pk }}">{{ i.address_street_app }}</span>,
                <span id="num_{{ i.pk }}">{{ i.address_num }}</span>.
            </td>

            </tr>

        {% endfor %}


    {% endfor %}

     <tr id="row_" class="hidden">
            <td>
                <a href="" id="order_"> </a>  в работе... <a href="" id="delete_">Удалить</a><br>
                <span id="text_order_"></span>
            </td>
            <td width = 50></td>
            <td><span id="customer_name_"></span>, |
                <span id="customer_phone_"></span><br>
                <span id="city_"></span>,
                <span id="street_app_"></span>,
                <span id="num_"></span>.
            </td>

            </tr>
</table>





{% endblock body %}